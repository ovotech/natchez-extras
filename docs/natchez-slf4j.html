<!DOCTYPE html><html><head><title>natchez-extras: Natchez SLF4J</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="OVO Energy" /><meta name="description" content="Datadog integrations for functional Scala" /><meta name="og:image" content="/natchez-extras/img/poster.png" /><meta name="image" property="og:image" content="/natchez-extras/img/poster.png" /><meta name="og:title" content="natchez-extras: Natchez SLF4J" /><meta name="title" property="og:title" content="natchez-extras: Natchez SLF4J" /><meta name="og:site_name" content="natchez-extras" /><meta name="og:url" content="https://ovotech.github.io/natchez-extras/" /><meta name="og:type" content="website" /><meta name="og:description" content="Datadog integrations for functional Scala" /><link rel="icon" type="image/png" href="/natchez-extras/img/favicon.png" /><meta name="twitter:title" content="natchez-extras: Natchez SLF4J" /><meta name="twitter:image" content="/natchez-extras/img/poster.png" /><meta name="twitter:description" content="Datadog integrations for functional Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/natchez-extras/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/natchez-extras/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/natchez-extras/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/natchez-extras/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/natchez-extras/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/natchez-extras/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/natchez-extras/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/natchez-extras/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/natchez-extras/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/natchez-extras/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/natchez-extras/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/natchez-extras/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/natchez-extras/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/natchez-extras/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/natchez-extras/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/natchez-extras/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/natchez-extras/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/natchez-extras/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/natchez-extras/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/natchez-extras/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/natchez-extras/highlight/styles/vs.css" /><link rel="stylesheet" href="/natchez-extras/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/natchez-extras/" class="brand"><div class="brand-wrapper"></div><span>natchez-extras</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/" title="Metrics" class="">Metrics</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-datadog.html" title="Natchez Datadog" class="">Natchez Datadog</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-combine.html" title="Natchez Combine" class="">Natchez Combine</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-doobie.html" title="Natchez Doobie" class="">Natchez Doobie</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-fs2.html" title="Natchez FS2" class="">Natchez FS2</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-http4s.html" title="Natchez HTTP4s" class="">Natchez HTTP4s</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-log4cats.html" title="Natchez Log4Cats" class="">Natchez Log4Cats</a></div> <div class="sidebar-nav-item active "><a href="/natchez-extras/docs/natchez-slf4j.html" title="Natchez SLF4J" class="active">Natchez SLF4J</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-testkit.html" title="Natchez Testkit" class="">Natchez Testkit</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/ovotech/natchez-extras" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/ovotech/natchez-extras" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="ovotech" data-github-repo="natchez-extras"><div class="content-wrapper"><section><h1 id="natchez-slf4j">Natchez SLF4J</h1>

<p>The module provides a natchez <code class="language-plaintext highlighter-rouge">EntryPoint</code> that sends tracing information to an
SLF4J logger. At OVO, we use this to make it easy to see tracing information in
the terminal when running locally. Once you have the <code class="language-plaintext highlighter-rouge">EntryPoint</code> you can then
use natchez as described in <a href="https://github.com/tpolecat/natchez/blob/master/README.md">its
README</a>.</p>

<h2 id="installation">Installation</h2>

<p>Add this module and an SLF4J binding (in this example we’re using
<a href="http://logback.qos.ch/">Logback</a>) to your <code class="language-plaintext highlighter-rouge">build.sbt</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">natchezExtrasVersion</span> <span class="k">=</span> <span class="s">"4.0.0"</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="s">"ch.qos.logback"</span>  <span class="o">%</span>  <span class="s">"logback-classic"</span>      <span class="o">%</span> <span class="s">"1.2.3"</span><span class="o">,</span>
  <span class="s">"com.ovoenergy"</span>   <span class="o">%%</span> <span class="s">"natchez-extras-slf4j"</span> <span class="o">%</span> <span class="n">natchezExtrasVersion</span>
<span class="o">)</span>

</code></pre></div></div>

<h2 id="example-usage">Example usage</h2>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">ExitCode</span><span class="o">,</span> <span class="nc">IO</span><span class="o">,</span> <span class="nc">IOApp</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.slf4j.Slf4j</span>
<span class="k">import</span> <span class="nn">natchez.EntryPoint</span>

<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">object</span> <span class="nc">MyTracedApp</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="cm">/**
   * Create a Natchez entrypoint that will send traces to SLF4J
   */</span>
  <span class="k">val</span> <span class="nv">slf4j</span><span class="k">:</span> <span class="kt">EntryPoint</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Slf4j</span><span class="o">.</span><span class="py">entryPoint</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>

  <span class="cm">/**
   * This app creates a root span, adds a tag to set the env to UAT
   * then creates a subspan that sleeps for two seconds
   */</span>
  <span class="k">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">slf4j</span><span class="o">.</span><span class="py">root</span><span class="o">(</span><span class="s">"root-span"</span><span class="o">).</span><span class="py">use</span> <span class="o">{</span> <span class="n">rootSpan</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">rootSpan</span><span class="o">.</span><span class="py">put</span><span class="o">(</span><span class="s">"env"</span> <span class="o">-&gt;</span> <span class="s">"uat"</span><span class="o">)</span>
        <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">rootSpan</span><span class="o">.</span><span class="py">span</span><span class="o">(</span><span class="s">"child-span"</span><span class="o">).</span><span class="py">use</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nv">IO</span><span class="o">.</span><span class="py">sleep</span><span class="o">(</span><span class="mf">2.</span><span class="n">seconds</span><span class="o">))</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="nv">ExitCode</span><span class="o">.</span><span class="py">Success</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>If you run this example, you should see some output like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbt&gt; run
[info] Running MyTracedApp
14:14:26.296 [ioapp-compute-0] INFO natchez - root-span started
14:14:26.305 [ioapp-compute-0] INFO natchez - child-span started
14:14:28.318 [ioapp-compute-1] INFO natchez - child-span success
14:14:28.320 [ioapp-compute-1] INFO natchez - root-span success
[success] Total time: 3 s, completed 22-May-2020 14:14:28
</code></pre></div></div>

<p>Although you can see when each trace started and ended, eagle-eyed readers will
notice that the <code class="language-plaintext highlighter-rouge">env</code> tag we added to the root span is not visible. This is
because span tags get added to the SLF4J MDC (mapped diagnostic context) and by
default Logback doesn’t print the MDC to the console.</p>

<p>We can fix this by creating a Logback config file at
<code class="language-plaintext highlighter-rouge">src/main/resources/logback.xml</code> with the following content (the important part
is that the <code class="language-plaintext highlighter-rouge">&lt;pattern&gt;</code> element includes the <code class="language-plaintext highlighter-rouge">%mdc</code> pattern):</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"CONSOLE"</span>
		    <span class="na">class=</span><span class="s">"ch.qos.logback.core.ConsoleAppender"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;encoder&gt;</span>
      <span class="nt">&lt;pattern&gt;</span>%d{HH:mm:ss.SSS} [%thread] %level %logger{36} - %msg {%mdc}%n<span class="nt">&lt;/pattern&gt;</span>
    <span class="nt">&lt;/encoder&gt;</span>
  <span class="nt">&lt;/appender&gt;</span>

  <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">"debug"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"CONSOLE"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/root&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>

</code></pre></div></div>

<p>Now if we run the code again, we can see the span tags in the console too:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[info] Running MyTracedApp
14:31:19.835 [ioapp-compute-0] INFO natchez - root-span started {traceToken=b54bfc5d-91e7-497e-9227-f2380da4ba28}
14:31:19.846 [ioapp-compute-0] INFO natchez - child-span started {env=uat, traceToken=b54bfc5d-91e7-497e-9227-f2380da4ba28}
14:31:21.859 [ioapp-compute-1] INFO natchez - child-span success {env=uat, traceToken=b54bfc5d-91e7-497e-9227-f2380da4ba28}
14:31:21.860 [ioapp-compute-1] INFO natchez - root-span success {env=uat, traceToken=b54bfc5d-91e7-497e-9227-f2380da4ba28}
[success] Total time: 3 s, completed 22-May-2020 14:31:21
</code></pre></div></div>
</section></div></div></div></div><script src="/natchez-extras/highlight/highlight.pack.js"></script><script src="/natchez-extras/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/natchez-extras/js/search.js"></script><script src="/natchez-extras/js/docs.js"></script></body></html>