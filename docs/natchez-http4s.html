<!DOCTYPE html><html><head><title>natchez-extras: Natchez HTTP4s</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="OVO Energy" /><meta name="description" content="Datadog integrations for functional Scala" /><meta name="og:image" content="/natchez-extras/img/poster.png" /><meta name="image" property="og:image" content="/natchez-extras/img/poster.png" /><meta name="og:title" content="natchez-extras: Natchez HTTP4s" /><meta name="title" property="og:title" content="natchez-extras: Natchez HTTP4s" /><meta name="og:site_name" content="natchez-extras" /><meta name="og:url" content="https://ovotech.github.io/natchez-extras/" /><meta name="og:type" content="website" /><meta name="og:description" content="Datadog integrations for functional Scala" /><link rel="icon" type="image/png" href="/natchez-extras/img/favicon.png" /><meta name="twitter:title" content="natchez-extras: Natchez HTTP4s" /><meta name="twitter:image" content="/natchez-extras/img/poster.png" /><meta name="twitter:description" content="Datadog integrations for functional Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/natchez-extras/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/natchez-extras/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/natchez-extras/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/natchez-extras/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/natchez-extras/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/natchez-extras/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/natchez-extras/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/natchez-extras/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/natchez-extras/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/natchez-extras/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/natchez-extras/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/natchez-extras/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/natchez-extras/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/natchez-extras/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/natchez-extras/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/natchez-extras/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/natchez-extras/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/natchez-extras/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/natchez-extras/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/natchez-extras/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/natchez-extras/highlight/styles/vs.css" /><link rel="stylesheet" href="/natchez-extras/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/natchez-extras/" class="brand"><div class="brand-wrapper"></div><span>natchez-extras</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/" title="Metrics" class="">Metrics</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-datadog.html" title="Natchez Datadog" class="">Natchez Datadog</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-combine.html" title="Natchez Combine" class="">Natchez Combine</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-doobie.html" title="Natchez Doobie" class="">Natchez Doobie</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-fs2.html" title="Natchez FS2" class="">Natchez FS2</a></div> <div class="sidebar-nav-item active "><a href="/natchez-extras/docs/natchez-http4s.html" title="Natchez HTTP4s" class="active">Natchez HTTP4s</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-log4cats.html" title="Natchez Log4Cats" class="">Natchez Log4Cats</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-slf4j.html" title="Natchez SLF4J" class="">Natchez SLF4J</a></div> <div class="sidebar-nav-item  "><a href="/natchez-extras/docs/natchez-testkit.html" title="Natchez Testkit" class="">Natchez Testkit</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/ovotech/natchez-extras" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/ovotech/natchez-extras" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="ovotech" data-github-repo="natchez-extras"><div class="content-wrapper"><section><h1 id="natchez-http4s">Natchez HTTP4s</h1>

<p><code class="language-plaintext highlighter-rouge">natchez-extras-http4s</code> provides HTTP4s <a href="https://http4s.org/v0.21/middleware/">Middleware</a> to trace all HTTP requests.
At the time of writing there is a <a href="https://github.com/tpolecat/natchez/pull/75">PR on Natchez itself</a> that will provide this functionality.
When it is merged this module will continue to exist but as a wrapper that adds tags used by Datadog.</p>

<h2 id="installation">Installation</h2>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">natchezExtrasVersion</span> <span class="k">=</span> <span class="s">"6.1.0"</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="s">"com.ovoenergy"</span> <span class="o">%%</span> <span class="s">"natchez-extras-http4s-stable"</span> <span class="o">%</span> <span class="n">natchezExtrasVersion</span>
<span class="o">)</span>
</code></pre></div></div>

<h2 id="usage">Usage</h2>

<p>These examples assume you’ve installed the following extra dependencies:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">http4sVersion</span> <span class="k">=</span> <span class="s">"0.23.9"</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="s">"org.http4s"</span>    <span class="o">%%</span> <span class="s">"http4s-blaze-server"</span>   <span class="o">%</span> <span class="n">http4sVersion</span><span class="o">,</span>
  <span class="s">"org.http4s"</span>    <span class="o">%%</span> <span class="s">"http4s-blaze-client"</span>   <span class="o">%</span> <span class="n">http4sVersion</span>
<span class="o">)</span>
</code></pre></div></div>

<p>To use Natchez HTTP4s you create an <code class="language-plaintext highlighter-rouge">HttpApp[Kleisli[F, Span[F], *]]</code> (i.e. an HttpApp that requires a span to run)
and pass it into <code class="language-plaintext highlighter-rouge">TraceMiddleware</code> to obtain an <code class="language-plaintext highlighter-rouge">HttpApp[F]</code> you can then run normally.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.data.Kleisli</span>
<span class="k">import</span> <span class="nn">cats.effect._</span>
<span class="k">import</span> <span class="nn">cats.syntax.flatMap._</span>
<span class="k">import</span> <span class="nn">cats.syntax.functor._</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.datadog.Datadog</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.http4s.Configuration</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.http4s.server.TraceMiddleware</span>
<span class="k">import</span> <span class="nn">natchez.</span><span class="o">{</span><span class="nc">EntryPoint</span><span class="o">,</span> <span class="nc">Span</span><span class="o">,</span> <span class="nc">Trace</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.http4s.blaze.client.BlazeClientBuilder</span>
<span class="k">import</span> <span class="nn">org.http4s.dsl.Http4sDsl</span>
<span class="k">import</span> <span class="nn">org.http4s.blaze.server.BlazeServerBuilder</span>
<span class="k">import</span> <span class="nn">org.http4s.</span><span class="o">{</span><span class="nc">HttpApp</span><span class="o">,</span> <span class="nc">HttpRoutes</span><span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">object</span> <span class="nc">NatchezHttp4s</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="cm">/**
   * An example API with a simple GET endpoint
   * and a POST endpoint that does a few sub operations
   */</span>
  <span class="k">def</span> <span class="nf">createRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Trace:</span> <span class="kt">Temporal</span><span class="o">]</span><span class="k">:</span> <span class="kt">HttpRoutes</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">dsl</span> <span class="k">=</span> <span class="nc">Http4sDsl</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
    <span class="k">import</span> <span class="nn">dsl._</span>
    <span class="nv">HttpRoutes</span><span class="o">.</span><span class="py">of</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">GET</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="k">=&gt;</span>
        <span class="nc">Ok</span><span class="o">(</span><span class="s">"Well done"</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">POST</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="k">=&gt;</span>
        <span class="k">for</span> <span class="o">{</span>
          <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Trace</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">span</span><span class="o">(</span><span class="s">"operation-1"</span><span class="o">)(</span><span class="nc">Temporal</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">sleep</span><span class="o">(</span><span class="mf">10.</span><span class="n">millis</span><span class="o">))</span>
          <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Trace</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">span</span><span class="o">(</span><span class="s">"operation-2"</span><span class="o">)(</span><span class="nc">Temporal</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">sleep</span><span class="o">(</span><span class="mf">50.</span><span class="n">millis</span><span class="o">))</span>
          <span class="n">res</span> <span class="k">&lt;-</span> <span class="nc">Created</span><span class="o">(</span><span class="s">"Thanks"</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">yield</span> <span class="n">res</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Create a Natchez entrypoint that will send traces to Datadog
   */</span>
  <span class="k">val</span> <span class="nv">datadog</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">EntryPoint</span><span class="o">[</span><span class="kt">IO</span><span class="o">]]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">httpClient</span> <span class="k">&lt;-</span> <span class="nc">BlazeClientBuilder</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">withDefaultSslContext</span><span class="o">.</span><span class="py">resource</span>
      <span class="n">entryPoint</span> <span class="k">&lt;-</span> <span class="nv">Datadog</span><span class="o">.</span><span class="py">entryPoint</span><span class="o">(</span><span class="n">httpClient</span><span class="o">,</span> <span class="s">"example-http-api"</span><span class="o">,</span> <span class="s">"default-resource"</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">entryPoint</span>


  <span class="k">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">datadog</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">entryPoint</span> <span class="k">=&gt;</span>

      <span class="cm">/**
       * Our routes need a Trace instance to create spans etc
       * and the only type that has a trace instance is a Kleisli
       */</span>
      <span class="k">type</span> <span class="kt">TracedIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Kleisli</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Span</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>, <span class="kt">A</span><span class="o">]</span>
      <span class="k">val</span> <span class="nv">tracedRoutes</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">TracedIO</span><span class="o">]</span> <span class="k">=</span> <span class="n">createRoutes</span><span class="o">[</span><span class="kt">TracedIO</span><span class="o">].</span><span class="py">orNotFound</span>

      <span class="cm">/**
       * We then apply the TraceMiddleware to the routes to obtain an `HttpApp[IO]`.
       * The middleware will create traces for each incoming request.
       */</span>
      <span class="k">val</span> <span class="nv">routes</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span>
        <span class="nc">TraceMiddleware</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">entryPoint</span><span class="o">,</span> <span class="nv">Configuration</span><span class="o">.</span><span class="py">default</span><span class="o">())(</span><span class="n">tracedRoutes</span><span class="o">)</span>

      <span class="cm">/**
       * We can then serve the routes as normal
       */</span>
      <span class="nc">BlazeServerBuilder</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>
        <span class="o">.</span><span class="py">bindHttp</span><span class="o">(</span><span class="mi">8080</span><span class="o">,</span> <span class="s">"0.0.0.0"</span><span class="o">)</span>
        <span class="o">.</span><span class="py">withHttpApp</span><span class="o">(</span><span class="n">routes</span><span class="o">)</span>
        <span class="o">.</span><span class="py">withoutBanner</span>
        <span class="o">.</span><span class="py">serve</span>
        <span class="o">.</span><span class="py">compile</span>
        <span class="o">.</span><span class="py">lastOrError</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Running the above app and hitting the <code class="language-plaintext highlighter-rouge">POST</code> endpoint should generate a trace like this:</p>

<p><img src="/natchez-extras/img/example-http-trace.png" alt="datadog trace" /></p>

<h2 id="tracing-only-some-routes">Tracing only some routes</h2>

<p>Often you don’t want to trace all of your routes, for example if you have a healthcheck route
that is polled by a load balancer every few seconds you may wish to exclude it from your traces.</p>

<p>You can do this using <code class="language-plaintext highlighter-rouge">.fallthroughTo</code> provided in the <code class="language-plaintext highlighter-rouge">syntax</code> package which allows the combination
of un-traced <code class="language-plaintext highlighter-rouge">HttpRoutes[F]</code> and the <code class="language-plaintext highlighter-rouge">HttpApp[F]</code> that the tracing middleware returns:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.data.Kleisli</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">ExitCode</span><span class="o">,</span> <span class="nc">IO</span><span class="o">,</span> <span class="nc">IOApp</span><span class="o">,</span> <span class="nc">Resource</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.datadog.Datadog</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.http4s.Configuration</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.http4s.server.TraceMiddleware</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.http4s.server.syntax.KleisliSyntax</span>
<span class="k">import</span> <span class="nn">natchez.</span><span class="o">{</span><span class="nc">EntryPoint</span><span class="o">,</span> <span class="nc">Span</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.http4s._</span>
<span class="k">import</span> <span class="nn">org.http4s.blaze.client.BlazeClientBuilder</span>
<span class="k">import</span> <span class="nn">org.http4s.dsl.io._</span>
<span class="k">import</span> <span class="nn">org.http4s.blaze.server.BlazeServerBuilder</span>

<span class="k">object</span> <span class="nc">Main</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>
  
  <span class="k">type</span> <span class="kt">TraceIO</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Kleisli</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Span</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>, <span class="kt">A</span><span class="o">]</span>
  <span class="k">val</span> <span class="nv">conf</span><span class="k">:</span> <span class="kt">Configuration</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Configuration</span><span class="o">.</span><span class="py">default</span><span class="o">()</span>

  <span class="k">val</span> <span class="nv">datadog</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">EntryPoint</span><span class="o">[</span><span class="kt">IO</span><span class="o">]]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">httpClient</span> <span class="k">&lt;-</span> <span class="nc">BlazeClientBuilder</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">withDefaultSslContext</span><span class="o">.</span><span class="py">resource</span>
      <span class="n">entryPoint</span> <span class="k">&lt;-</span> <span class="nv">Datadog</span><span class="o">.</span><span class="py">entryPoint</span><span class="o">(</span><span class="n">httpClient</span><span class="o">,</span> <span class="s">"example-http-api"</span><span class="o">,</span> <span class="s">"default-resource"</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">entryPoint</span>

  <span class="k">val</span> <span class="nv">healthcheck</span><span class="k">:</span> <span class="kt">HttpRoutes</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">HttpRoutes</span><span class="o">.</span><span class="py">of</span> <span class="o">{</span> <span class="k">case</span> <span class="nc">GET</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="o">/</span> <span class="s">"health"</span> <span class="k">=&gt;</span> <span class="nc">Ok</span><span class="o">(</span><span class="s">"healthy"</span><span class="o">)</span> <span class="o">}</span>
  
  <span class="k">val</span> <span class="nv">application</span><span class="k">:</span> <span class="kt">HttpRoutes</span><span class="o">[</span><span class="kt">TraceIO</span><span class="o">]</span> <span class="k">=</span> 
    <span class="nv">HttpRoutes</span><span class="o">.</span><span class="py">pure</span><span class="o">(</span><span class="nc">Response</span><span class="o">(</span><span class="n">status</span> <span class="k">=</span> <span class="nv">Status</span><span class="o">.</span><span class="py">InternalServerError</span><span class="o">))</span>
   
  <span class="k">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">datadog</span><span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">entryPoint</span> <span class="k">=&gt;</span>

      <span class="k">val</span> <span class="nv">combinedRoutes</span><span class="k">:</span> <span class="kt">HttpApp</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span>
        <span class="nv">healthcheck</span><span class="o">.</span><span class="py">fallthroughTo</span><span class="o">(</span><span class="nc">TraceMiddleware</span><span class="o">(</span><span class="n">entryPoint</span><span class="o">,</span> <span class="n">conf</span><span class="o">)(</span><span class="nv">application</span><span class="o">.</span><span class="py">orNotFound</span><span class="o">))</span>
    
      <span class="nc">BlazeServerBuilder</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>
        <span class="o">.</span><span class="py">withHttpApp</span><span class="o">(</span><span class="n">combinedRoutes</span><span class="o">)</span>
        <span class="o">.</span><span class="py">bindHttp</span><span class="o">(</span><span class="n">port</span> <span class="k">=</span> <span class="mi">8080</span><span class="o">)</span>
        <span class="o">.</span><span class="py">serve</span>
        <span class="o">.</span><span class="py">compile</span>
        <span class="o">.</span><span class="py">lastOrError</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="configuration">Configuration</h2>

<p>Given that every HTTP API is likely to have different tracing requirements <code class="language-plaintext highlighter-rouge">natchez-http4s</code> attempts to be as configurable as possible.
The <code class="language-plaintext highlighter-rouge">Configuration</code> object passed to <code class="language-plaintext highlighter-rouge">TraceMiddleware</code> defines how to turn an HTTP requests and responses into Natchez tags. By default
it is set up to create tags suitable for Datadog but you can use the helper functions in <code class="language-plaintext highlighter-rouge">Configuration</code> to create your own configs:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.http4s.Configuration</span>
<span class="k">import</span> <span class="nn">com.ovoenergy.natchez.extras.http4s.Configuration.TagReader._</span>
<span class="k">import</span> <span class="nn">natchez.TraceValue.BooleanValue</span>
<span class="k">import</span> <span class="nn">cats.syntax.semigroup._</span>

<span class="k">object</span> <span class="nc">CustomConfigExample</span> <span class="o">{</span>

  <span class="cm">/**
   * Describe what we want to read from request and put as tags into the span.
   * This configuration only adds the url and the method. You can use `|+|` to combine
   * together configurations.
   */</span>
  <span class="k">val</span> <span class="nv">customRequestConfig</span><span class="k">:</span> <span class="kt">RequestReader</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">Configuration</span><span class="o">.</span><span class="py">uri</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="s">"http_request_url"</span><span class="o">)</span> <span class="o">|+|</span>
    <span class="nv">Configuration</span><span class="o">.</span><span class="py">method</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="s">"http_method"</span><span class="o">)</span>

  <span class="cm">/**
   * Describe what to read from the HTTP response generated by the app and put into tags.
   * This configuration won't read anything but will put failed: true if the response is not a 2xx
   */</span>
  <span class="k">val</span> <span class="nv">customResponseConfig</span><span class="k">:</span> <span class="kt">ResponseReader</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">Configuration</span><span class="o">.</span><span class="py">ifFailure</span><span class="o">(</span><span class="nv">Configuration</span><span class="o">.</span><span class="py">const</span><span class="o">(</span><span class="s">"failed"</span><span class="o">,</span> <span class="nc">BooleanValue</span><span class="o">(</span><span class="kc">true</span><span class="o">)))</span>

  <span class="cm">/**
   * The request &amp; response configurations are combined together into this case class
   * which can then be passed to `TraceMiddleware`
   */</span>
  <span class="k">val</span> <span class="nv">customConfig</span><span class="k">:</span> <span class="kt">Configuration</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Configuration</span><span class="o">(</span>
      <span class="n">request</span> <span class="k">=</span> <span class="n">customRequestConfig</span><span class="o">,</span>
      <span class="n">response</span> <span class="k">=</span> <span class="n">customResponseConfig</span>
    <span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

</section></div></div></div></div><script src="/natchez-extras/highlight/highlight.pack.js"></script><script src="/natchez-extras/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/natchez-extras/js/search.js"></script><script src="/natchez-extras/js/docs.js"></script></body></html>